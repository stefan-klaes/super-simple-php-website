$error = [];

$error_txt = '';
$is_error = '';

// Processing form data when form is submitted
if ( $_SERVER['REQUEST_METHOD'] == 'POST' ) {

    $name = isset($_POST['name']) ? htmlspecialchars( $_POST['name'] ) : '';
    $mail = isset($_POST['mail']) ? strip_tags( $_POST['mail'] ) : '';
    $betreff = isset($_POST['betreff']) ? htmlspecialchars( $_POST['betreff'] ) : '';
    $message = isset($_POST['message']) ? nl2br( strip_tags( $_POST['message'] ) ) : '';
    $datenschutz = isset($_POST['datenschutz']) ? strip_tags( $_POST['datenschutz'] ) : '';

    $is_error = 'no';

    if ( $name == '' ) {
        $error['name'] = 'Bitte gib einen Namen an.';
        $is_error = 'yes';
    }
    if ( $betreff == '' ) {
        $error['betreff'] = 'Bitte gib einen Betreff an.';
        $is_error = 'yes';
    }
    if ( $mail == '' ) {
        $error['mail'] = 'Bitte gib eine E-Mail Adresse an.';
        $is_error = 'yes';
    }
    else if ( !is_email($mail) ) {
        $error['mail'] = 'Die E-Mail Adresse ist nicht korrekt.';
        $is_error = 'yes';
    }
    if ( $message == '' ) {
        $error['message'] = 'Bitte schreibe eine Nachricht.';
        $is_error = 'yes';
    }
    if ( $datenschutz !== 'yes' ) {
        $error['datenschutz'] = 'Bitte lies diesen Absatz und stimme zu.';
        $is_error = 'yes';
    }
    
    $coreInstance = new Core();

    if ( $is_error == 'yes' ) {
        $error_txt = '<span class='sticky_hinweis sticky_error stickyleft'>Formular nicht abgeschickt. Überprüfe die Angaben.</span>';
        echo $error_txt;
        ?>
        <script>
            const myTimeout = setTimeout(hide_hinweise, 4000);

            function hide_hinweise() {
                var sticky_hinweis = document.getElementsByClassName('sticky_hinweis');
                for ( i= 0; i<sticky_hinweis.length; i++ ) {
                    sticky_hinweis[i].style.display = 'none';
                }
                clearTimeout(myTimeout);
            }
        
        </script>
        <?php
        
        $coreInstance->tracking($request_url,'event','failed kontaktanfrage');
    }
    else {
        // formular erfolgreich abgeschickt
        
        $headline = 'Danke';

        $to = 'stefan@coden-lassen.de';
        $subject = $betreff;
        $reply_to = $mail;
        $reply_to_name = $name;
        sendMail($to, $subject, $message, $reply_to, $reply_to_name);

        $coreInstance->tracking($request_url,'event','kontaktanfrage');
        // END formular erfolgreich abgeschickt
    }

    